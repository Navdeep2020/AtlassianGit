<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Your Connect App</title>
  <script src="https://connect-cdn.atl-paas.net/all.js"></script>
  <style>
    /* Overall page styling */
  * {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f0f4f8;
    }

    /* Header Style */
    header {
      background-color: #6200ea;
      color: white;
      padding: 1rem 0;
      text-align: center;
      font-size: 1.5rem;
    }

    /* Main container wrapper */
    .container {
      padding: 1rem;
    }

    /* Team Member Grid */
    .team-member-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      padding-bottom: 1rem;
    }

    /* Team Member Card Style */
    .team-card {
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      background-color: #ffffff;
      padding: 1rem;
      text-align: left;
    }

    .team-card h3 {
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
    }

    .team-card .main-kpi {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
  </style>
</head>
<body>

<!-- Header -->
<header>
  JIRA KPI Dashboard
</header>

<!-- Main Container -->
<div class="container">
  <div id="team-members-container" class="team-member-grid"></div>
</div>

<script>
  // Fetch data from response.json
  function fetchDataAndInitialize() {
    fetch("response.json")
      .then(response => response.json())
      .then(data => {
        const issues = data.issues || [];
        const teamData = {};

        issues.forEach(issue => {
          const assignee = issue.fields.assignee?.displayName || "Unassigned";
          const worklogs = issue.fields.worklog?.worklogs || [];
          const statusId = issue.fields.status?.id || "";
          const statusName = issue.fields.status?.name || "";
          const sprintField = issue.fields.customfield_10104 || [];
          const prField = issue.fields.customfield_11201?.summaryBean?.summary?.pullrequest?.overall || {};
          const storyPoint = issue.fields.customfield_10102 || 0;

          if (!teamData[assignee]) {
            teamData[assignee] = {
              name: assignee,
              storyPoints: 0,
              timeSpent: 0,
              blockedTickets: 0,
              carryForwardTickets: 0,
              prs: 0,
              yetToStart: 0,
              completed: 0
            };
          }

          // Aggregate data for each assignee
          teamData[assignee].storyPoints += storyPoint;
          teamData[assignee].timeSpent += worklogs.reduce((sum, log) => sum + log.timeSpentSeconds / 3600, 0); // Convert seconds to hours
          if (statusName === "Blocked") {
            teamData[assignee].blockedTickets += 1;
          }
          
          if (statusId === "1") { // Yet to Start
            teamData[assignee].yetToStart += 1;
          }
          if (statusId === "6") { // Completed
            teamData[assignee].completed += 1;
          }
          
          if (sprintField.length > 1) {
            teamData[assignee].carryForwardTickets += 1;
          }
          teamData[assignee].prs += prField.total || 0;
        });

        // Convert teamData object to array and populate the UI
        const teamMembers = Object.values(teamData);
        generateTeamMemberCards(teamMembers);
        renderPieCharts(teamMembers); // Render pie charts with the team member data
      })
      .catch(error => console.error("Error fetching data:", error));
  }

  // Function to dynamically generate team member cards
  function generateTeamMemberCards(data) {
    const container = document.getElementById('team-members-container');
    container.innerHTML = ''; // Clear any existing data

    data.forEach(member => {
      const card = document.createElement('div');
      card.className = 'team-card';
      card.innerHTML = `
        <h3>${member.name}</h3>
        <div class="main-kpi">Story Points: ${member.storyPoints}</div>
        <p>Time Logged: ${member.timeSpent.toFixed(2)} hours</p>
        <p>Blocked Tickets: ${member.blockedTickets}</p>
        <p>Carry Forward Tickets: ${member.carryForwardTickets}</p>
        <p>PRs: ${member.prs}</p>
        <p>Yet to Start: ${member.yetToStart}</p>
        <p>Completed: ${member.completed}</p>
      `;
      container.appendChild(card);
    });
  }

  // Initialize the dashboard
  document.addEventListener('DOMContentLoaded', () => {
    fetchDataAndInitialize();
  });
</script>

</body>
</html>
