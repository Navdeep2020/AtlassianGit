<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Your Connect App</title>
  <script src="https://connect-cdn.atl-paas.net/all.js"></script>
  <style>
    /* Overall page styling */
 body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
    background-color: #ffffff; /* White background */
    color: #008080; /* Teal text color */
    text-align: center;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }

    .container {
      background: rgba(255, 255, 255, 0.8);
      color: #008080;
      padding: 20px;
      border-radius: 10px;
      width: 80%;
      text-align: center;
    }

    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    h3 {
      font-size: 1.5em;
      margin-bottom: 20px;
    }

    select, button {
      padding: 10px;
      font-size: 1em;
      margin: 10px 0;
      border: 1px solid #008080;
      border-radius: 5px;
      cursor: pointer;
      background-color: #ffffff;
      color: #008080;
    }

    select:hover, button:hover {
      background-color: #006666;
      color: #ffffff;
    }

    ul {
      list-style-type: none;
      padding: 0;
      margin: 20px auto;
      text-align: center;
    }

    ul li {
      background-color: #ffffff;
      color: #008080;
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
      font-size: 1em;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Team Work Data</h2>
    <button id="fetch-sprint-data-btn">Fetch Sprint Data</button>
    <ul id="teamList"></ul>
  </div>

  <script>
    const name = []; // Array to store unique names
    const timeSpent = []; // Array to store corresponding time spent
    const blockedTickets = [];
    const carryForwardTickets = [];
    const pullRequests = [];
    
    // New code
    
    // Fetch data from the JSON file
     function fetchData() {
        fetch('response.json') // Replace with actual file path if necessary
            .then(response => response.json())
            .then(data => {
                // Clear existing data
                name.length = 0;
                timeSpent.length = 0;
                blockedTickets.length = 0;
                carryForwardTickets.length = 0;
                pullRequests.length = 0;

                // Set to track unique assignees
                const uniqueAssignees = new Set();

                // Loop through all issues
                data.issues.forEach(issue => {
                    const assignee = issue.fields.assignee?.name || "Unassigned";
                    const worklogs = issue.fields.worklog?.worklogs || [];
                    const statusName = issue.fields.status?.name || "";
                    const sprintField = issue.fields.customfield_10104 || [];
                    const prField = issue.fields.customfield_11201 ? JSON.parse(issue.fields.customfield_11201) : null;

                    // Calculate total time spent in minutes
                    const totalTimeSpentInMinutes = worklogs.reduce((total, log) => {
                      return total + parseTimeSpent(log.timeSpent || "0m");
                    }, 0);

                     // Check if issue is carry forward
                    const isCarryForward = sprintField.length > 1;

                    // Get the PR count
                    const prCount = prField?.summaryBean?.summary?.pullrequest?.overall?.stateCount || 0;
                    
                    // Add or update assignee data
                    if (!uniqueAssignees.has(assignee)) {
                      uniqueAssignees.add(assignee);
                      name.push(assignee);
                      timeSpent.push(totalTimeSpentInMinutes);
                      blockedTickets.push(statusName === "Blocked" ? 1 : 0);
                      carryForwardTickets.push(isCarryForward ? 1 : 0);
                      pullRequests.push(prCount);
                    } else {
                      const index = name.indexOf(assignee);
                      timeSpent[index] += totalTimeSpentInMinutes;
                      if (statusName === "Blocked") {
                        blockedTickets[index]++;
                      }
                      if (isCarryForward) {
                        carryForwardTickets[index]++;
                      }
                      pullRequests[index] += prCount;
                    }
                  });

                // Update the HTML with the unique assignees and their total time spent
                updateHTML();
            })
            .catch(error => console.error('Error fetching data:', error));
    }

      // Update the HTML to display the list
      function updateHTML() {
        const teamList = document.getElementById('teamList');
        teamList.innerHTML = ''; // Clear previous entries
      
        // Loop through the name array to display assignees, their time spent, and blocked tickets
        name.forEach((person, index) => {
          const listItem = document.createElement('li');
          listItem.textContent = `Name: ${person}, Time Spent: ${formatTimeSpent(timeSpent[index])}, Blocked Tickets: ${blockedTickets[index]}, Carry Forward Tickets: ${carryForwardTickets[index]}, PRs: ${pullRequests[index]}`;
          teamList.appendChild(listItem);
        });
      }

    document.getElementById('fetch-sprint-data-btn').addEventListener('click', fetchData);


    // Helper function to parse time strings like "2h 30m" or "1d 2h" into total minutes
function parseTimeSpent(timeString) {
  let totalMinutes = 0;

  // Match patterns like "1d", "2h", "30m"
  const timeParts = timeString.match(/(\d+d|\d+h|\d+m)/g);

  if (timeParts) {
    timeParts.forEach(part => {
      if (part.includes('d')) {
        totalMinutes += parseInt(part) * 24 * 60; // Convert days to minutes
      } else if (part.includes('h')) {
        totalMinutes += parseInt(part) * 60; // Convert hours to minutes
      } else if (part.includes('m')) {
        totalMinutes += parseInt(part); // Minutes
      }
    });
  }

  return totalMinutes;
}

// Helper function to format total minutes into "Xh Ym"
function formatTimeSpent(totalMinutes) {
  const hours = Math.floor(totalMinutes / 60);
  const minutes = totalMinutes % 60;
  return `${hours}h ${minutes}m`;
}
  
    // Fetch and display issues when a sprint is selected
    sprintDropdown.addEventListener('change', function() {
      const projectName = projectDropdown.value;
      const sprintName = this.value;
      issuesList.innerHTML = '';

      if (!sprintName) return;

      const issuesUrl = `/rest/api/2/search?jql=project="${projectName}" AND sprint="${sprintName}"`;
      AP.request({
        url: issuesUrl,
        type: 'GET',
        success: function(response) {
          const issues = JSON.parse(response).issues;
          if (issues.length === 0) {
            issuesList.innerHTML = '<li>No issues found for this sprint.</li>';
            return;
          }
          issues.forEach(issue => {
            const li = document.createElement('li');
            li.textContent = `Key: ${issue.key}, Summary: ${issue.fields.summary}`;
            issuesList.appendChild(li);
          });
        },
        error: function(err) {
          console.error('Error fetching issues:', err);
          issuesList.innerHTML = '<li>Error fetching issues for this sprint.</li>';
        }
      });
    });
  </script>
</body>
</html>


